name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build-and-test:
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest]
      fail-fast: false
    runs-on: ${{ matrix.os }}
    
    steps:
    - uses: actions/checkout@v4

    - name: Verify repo clean
      shell: pwsh
      run: ./tools/verify-repo-clean.ps1
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'
    
    - name: Restore dependencies
      run: dotnet restore
    
    - name: Check for vulnerable packages
      shell: pwsh
      run: |
        Write-Host "Checking for vulnerable packages..."
        $output = dotnet list package --vulnerable --include-transitive 2>&1 | Out-String
        Write-Host $output
        
        if ($output -match "has the following vulnerable packages") {
          Write-Error "Vulnerable packages detected. Please update dependencies."
          exit 1
        }
        
        Write-Host "No vulnerable packages found."
    
    - name: Validate Database Migrations
      shell: pwsh
      run: |
        Write-Host "Building migration tool..."
        dotnet build tools/TILSOFTAI.Migrations/TILSOFTAI.Migrations.csproj --configuration Release
        
        Write-Host "Validating migration scripts..."
        # Dry-run validation without actual database connection
        # This ensures SQL scripts are syntactically correct and embedded properly
        $embeddedScripts = dotnet run --project tools/TILSOFTAI.Migrations/TILSOFTAI.Migrations.csproj -- status --connection "Server=.;Database=TILSOFTAI_CI_VALIDATION;Integrated Security=true;" --pending-only 2>&1
        
        if ($LASTEXITCODE -eq 0) {
          Write-Host "Migration scripts are valid."
        } else {
          Write-Warning "Migration validation encountered issues (may be expected if no test database available)"
          Write-Host "This is informational only - build will continue."
        }
    
    - name: Build
      run: dotnet build --no-restore --configuration Release

    
    - name: Test
      run: dotnet test --no-build --configuration Release --verbosity normal
    
    - name: SQL Lint Check
      shell: pwsh
      run: |
        Write-Host "Checking SQL files for common issues..."
        $sqlFiles = Get-ChildItem -Path sql -Filter *.sql -Recurse -ErrorAction SilentlyContinue
        $warningCount = 0
        
        foreach ($file in $sqlFiles) {
          $content = Get-Content $file.FullName -Raw
          
          # Check for SELECT *
          if ($content -match "SELECT \*") {
            Write-Warning "Found SELECT * in $($file.Name) - consider explicit columns for production code"
            $warningCount++
          }
          
          # Check for missing SET NOCOUNT ON in procedures
          if ($content -match "CREATE (OR ALTER )?PROCEDURE" -and $content -notmatch "SET NOCOUNT ON") {
            Write-Warning "Missing SET NOCOUNT ON in procedure $($file.Name)"
            $warningCount++
          }
        }
        
        Write-Host "SQL lint check complete. Found $warningCount potential issues."
        if ($warningCount -gt 0) {
          Write-Host "These are warnings only - build will continue."
        }

    - name: Verify Required SQL Modules
      shell: pwsh
      run: |
        Write-Host "Verifying required SQL modules exist..." -ForegroundColor Cyan
        $requiredModules = @(
          "sql/01_core",
          "sql/02_modules/analytics",
          "sql/99_seed/analytics"
        )
        $requiredFiles = @(
          "sql/02_modules/analytics/001_tables_analytics.sql",
          "sql/02_modules/analytics/003_sps_app_analytics.sql",
          "sql/02_modules/analytics/004_sps_ai_analytics.sql",
          "sql/02_modules/analytics/005_sps_ai_analytics_execute.sql",
          "sql/99_seed/analytics/001_seed_toolcatalog_analytics.sql"
        )
        
        $missing = @()
        
        # Check required directories
        foreach ($module in $requiredModules) {
          if (-not (Test-Path $module)) {
            $missing += "Directory: $module"
          }
        }
        
        # Check required files
        foreach ($file in $requiredFiles) {
          if (-not (Test-Path $file)) {
            $missing += "File: $file"
          }
        }
        
        if ($missing.Count -gt 0) {
          Write-Host ""
          Write-Host "ERROR: Required SQL modules are missing!" -ForegroundColor Red
          foreach ($m in $missing) {
            Write-Host "  - $m" -ForegroundColor Red
          }
          Write-Host ""
          Write-Host "The analytics module requires these files for proper operation." -ForegroundColor Yellow
          exit 1
        }
        
        Write-Host "All required SQL modules verified:" -ForegroundColor Green
        foreach ($file in $requiredFiles) {
          Write-Host "  ✓ $file" -ForegroundColor Green
        }

    # PATCH 31.02: Fixed secret scanning - now includes JSON and fails on detection
    - name: Verify No Hardcoded Credentials
      shell: pwsh
      run: |
        Write-Host "Checking for hardcoded credentials..." -ForegroundColor Cyan
        $issues = @()
        
        # Scan ALL relevant files including JSON (the previous version excluded *.json)
        $files = Get-ChildItem -Path ./src -Recurse -Include "*.cs", "*.json", "*.config", "*.ps1", "*.xml" |
          Where-Object { $_.FullName -notmatch '(\\|/)bin(\\|/)' -and $_.FullName -notmatch '(\\|/)obj(\\|/)' }
        
        foreach ($file in $files) {
          $content = Get-Content $file.FullName -Raw -ErrorAction SilentlyContinue
          if (-not $content) { continue }
          
          # Check for real credentials (not placeholders)
          if ($content -match '(?i)(Password|Pwd)\s*=\s*(?!(__|\\$env:|YOUR_|%%))([^;\\"]{3,})') {
            # Exclude known safe patterns
            if ($content -notmatch '__SQL_CONNECTION_STRING_FROM_ENV') {
              $issues += "$($file.FullName): potential hardcoded credential"
            }
          }
          
          # Check for API keys / tokens
          if ($content -match '(?i)(api[_-]?key|secret[_-]?key|access[_-]?token)\s*[:=]\s*[\\"''][a-zA-Z0-9+/=]{16,}') {
            $issues += "$($file.FullName): potential API key/token"
          }
        }
        
        if ($issues.Count -gt 0) {
          Write-Host ""
          Write-Host "ERROR: Hardcoded credentials detected!" -ForegroundColor Red
          foreach ($issue in $issues) {
            Write-Host "  - $issue" -ForegroundColor Red
          }
          exit 1  # FAIL CI, not just warning
        }
        
        Write-Host "No hardcoded credentials detected." -ForegroundColor Green

  # PATCH 31.04: Integration tests with SQL Server container
  integration-tests:
    runs-on: ubuntu-latest
    # Only run on main/develop push or PR to main
    if: github.event_name == 'push' || github.event.pull_request.base.ref == 'main'
    
    services:
      sqlserver:
        image: mcr.microsoft.com/mssql/server:2022-latest
        env:
          ACCEPT_EULA: "Y"
          MSSQL_SA_PASSWORD: "Integration_Test_P@ss1!"
          MSSQL_PID: Express
        ports:
          - 1433:1433
        options: >-
          --health-cmd "/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P 'Integration_Test_P@ss1!' -Q 'SELECT 1' -N -C || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
          --health-start-period 30s

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Install sqlcmd
        run: |
          curl https://packages.microsoft.com/keys/microsoft.asc | sudo tee /etc/apt/trusted.gpg.d/microsoft.asc
          sudo add-apt-repository "$(wget -qO- https://packages.microsoft.com/config/ubuntu/22.04/prod.list)"
          sudo apt-get update
          sudo apt-get install -y mssql-tools18 unixodbc-dev
          echo 'export PATH="$PATH:/opt/mssql-tools18/bin"' >> ~/.bashrc

      - name: Create Test Database
        run: |
          /opt/mssql-tools18/bin/sqlcmd \
            -S localhost -U sa -P 'Integration_Test_P@ss1!' \
            -N -C \
            -Q "CREATE DATABASE TILSOFTAI_Test;"

      - name: Deploy SQL Migrations
        shell: pwsh
        run: |
          $conn = "Server=localhost;Database=TILSOFTAI_Test;User ID=sa;Password=Integration_Test_P@ss1!;TrustServerCertificate=True;"
          
          # Deploy in order: core → atomic → modules → seeds
          $folders = @(
            "sql/01_core",
            "sql/02_atomic",
            "sql/02_modules/analytics",
            "sql/02_modules/model",
            "sql/99_seed"
          )
          
          foreach ($folder in $folders) {
            if (Test-Path $folder) {
              $files = Get-ChildItem -Path $folder -Filter "*.sql" -Recurse | Sort-Object Name
              foreach ($file in $files) {
                Write-Host "Deploying: $($file.FullName)" -ForegroundColor Cyan
                /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P 'Integration_Test_P@ss1!' -N -C -d TILSOFTAI_Test -i $file.FullName -b
                if ($LASTEXITCODE -ne 0) {
                  Write-Error "Failed to deploy: $($file.FullName)"
                  exit 1
                }
              }
            }
          }
          Write-Host "All SQL migrations deployed successfully." -ForegroundColor Green

      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build --no-restore --configuration Release

      - name: Run Integration Tests
        run: dotnet test tests/TILSOFTAI.IntegrationTests --no-build --configuration Release --verbosity normal
        env:
          TEST_SQL_CONNECTION: "Server=localhost;Database=TILSOFTAI_Test;User ID=sa;Password=Integration_Test_P@ss1!;TrustServerCertificate=True;"
