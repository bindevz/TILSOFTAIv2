name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build-and-test:
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest]
      fail-fast: false
    runs-on: ${{ matrix.os }}
    
    steps:
    - uses: actions/checkout@v4

    - name: Verify repo clean
      shell: pwsh
      run: ./tools/verify-repo-clean.ps1
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'
    
    - name: Restore dependencies
      run: dotnet restore
    
    - name: Check for vulnerable packages
      shell: pwsh
      run: |
        Write-Host "Checking for vulnerable packages..."
        $output = dotnet list package --vulnerable --include-transitive 2>&1 | Out-String
        Write-Host $output
        
        if ($output -match "has the following vulnerable packages") {
          Write-Error "Vulnerable packages detected. Please update dependencies."
          exit 1
        }
        
        Write-Host "No vulnerable packages found."
    
    - name: Validate Database Migrations
      shell: pwsh
      run: |
        Write-Host "Building migration tool..."
        dotnet build tools/TILSOFTAI.Migrations/TILSOFTAI.Migrations.csproj --configuration Release
        
        Write-Host "Validating migration scripts..."
        # Dry-run validation without actual database connection
        # This ensures SQL scripts are syntactically correct and embedded properly
        $embeddedScripts = dotnet run --project tools/TILSOFTAI.Migrations/TILSOFTAI.Migrations.csproj -- status --connection "Server=.;Database=TILSOFTAI_CI_VALIDATION;Integrated Security=true;" --pending-only 2>&1
        
        if ($LASTEXITCODE -eq 0) {
          Write-Host "Migration scripts are valid."
        } else {
          Write-Warning "Migration validation encountered issues (may be expected if no test database available)"
          Write-Host "This is informational only - build will continue."
        }
    
    - name: Build
      run: dotnet build --no-restore --configuration Release

    
    - name: Test
      run: dotnet test --no-build --configuration Release --verbosity normal
    
    - name: SQL Lint Check
      shell: pwsh
      run: |
        Write-Host "Checking SQL files for common issues..."
        $sqlFiles = Get-ChildItem -Path sql -Filter *.sql -Recurse -ErrorAction SilentlyContinue
        $warningCount = 0
        
        foreach ($file in $sqlFiles) {
          $content = Get-Content $file.FullName -Raw
          
          # Check for SELECT *
          if ($content -match "SELECT \*") {
            Write-Warning "Found SELECT * in $($file.Name) - consider explicit columns for production code"
            $warningCount++
          }
          
          # Check for missing SET NOCOUNT ON in procedures
          if ($content -match "CREATE (OR ALTER )?PROCEDURE" -and $content -notmatch "SET NOCOUNT ON") {
            Write-Warning "Missing SET NOCOUNT ON in procedure $($file.Name)"
            $warningCount++
          }
        }
        
        Write-Host "SQL lint check complete. Found $warningCount potential issues."
        if ($warningCount -gt 0) {
          Write-Host "These are warnings only - build will continue."
        }

    - name: Verify Required SQL Modules
      shell: pwsh
      run: |
        Write-Host "Verifying required SQL modules exist..." -ForegroundColor Cyan
        $requiredModules = @(
          "sql/01_core",
          "sql/02_modules/analytics",
          "sql/99_seed/analytics"
        )
        $requiredFiles = @(
          "sql/02_modules/analytics/001_tables_analytics.sql",
          "sql/02_modules/analytics/003_sps_app_analytics.sql",
          "sql/02_modules/analytics/004_sps_ai_analytics.sql",
          "sql/02_modules/analytics/005_sps_ai_analytics_execute.sql",
          "sql/99_seed/analytics/001_seed_toolcatalog_analytics.sql"
        )
        
        $missing = @()
        
        # Check required directories
        foreach ($module in $requiredModules) {
          if (-not (Test-Path $module)) {
            $missing += "Directory: $module"
          }
        }
        
        # Check required files
        foreach ($file in $requiredFiles) {
          if (-not (Test-Path $file)) {
            $missing += "File: $file"
          }
        }
        
        if ($missing.Count -gt 0) {
          Write-Host ""
          Write-Host "ERROR: Required SQL modules are missing!" -ForegroundColor Red
          foreach ($m in $missing) {
            Write-Host "  - $m" -ForegroundColor Red
          }
          Write-Host ""
          Write-Host "The analytics module requires these files for proper operation." -ForegroundColor Yellow
          exit 1
        }
        
        Write-Host "All required SQL modules verified:" -ForegroundColor Green
        foreach ($file in $requiredFiles) {
          Write-Host "  âœ“ $file" -ForegroundColor Green
        }

    - name: Verify No Hardcoded Credentials
      shell: pwsh
      run: |
        Write-Host "Checking for hardcoded credentials..." -ForegroundColor Cyan
        $patterns = @(
          @{ Pattern = 'password\s*=\s*["\u0027][^"\u0027]{1,50}["\u0027]'; Name = "password assignment" },
          @{ Pattern = 'pwd\s*=\s*["\u0027][^"\u0027]{1,50}["\u0027]'; Name = "pwd assignment" }
        )
        
        $issues = @()
        $ignorePatterns = @("*.md", "*.txt", "*.yaml", "*.yml", "*.json")
        
        $files = Get-ChildItem -Path . -Recurse -Include "*.ps1", "*.cs", "*.config" -Exclude $ignorePatterns
        
        foreach ($file in $files) {
          $content = Get-Content $file.FullName -Raw -ErrorAction SilentlyContinue
          if (-not $content) { continue }
          
          foreach ($p in $patterns) {
            if ($content -match $p.Pattern) {
              # Exclude environment variable references
              if ($content -notmatch '\$env:') {
                $issues += "$($file.Name): potential $($p.Name)"
              }
            }
          }
        }
        
        if ($issues.Count -gt 0) {
          Write-Host ""
          Write-Host "WARNING: Potential hardcoded credentials detected:" -ForegroundColor Yellow
          foreach ($issue in $issues) {
            Write-Host "  - $issue" -ForegroundColor Yellow
          }
          Write-Host ""
          Write-Host "This is a warning only - please review these files." -ForegroundColor Yellow
        } else {
          Write-Host "No hardcoded credentials detected." -ForegroundColor Green
        }
