# ============================================================================
# PATCH 31_02 — Secret Hygiene: Xóa Credentials, Env-Based Config, CI Scan
# ============================================================================
# Severity: P0
# Audit Finding: P0-SEC-01
# ============================================================================

patch: 31_02
title: "Xóa hardcoded credentials, env-based config, CI secret scanning gate"
severity: P0
status: pending

# ============================================================================
# VẤN ĐỀ HIỆN TẠI
# ============================================================================
problem:
  description: |
    1. appsettings.json chứa SQL ConnectionString với User ID=sa và Password=123
    2. bin/Release outputs có thể bị include trong zip/artifacts (đã thấy trong audit)
    3. CI credential check LOẠI TRỪ *.json files → appsettings.json bypass hoàn toàn
    4. Không có pre-commit hook hoặc CI gate thực sự block secrets

  evidence:
    appsettings_json:
      file: "src/TILSOFTAI.Api/appsettings.json"
      content: |
        "ConnectionString": "Server=.;Database=TILSOFTAI;User ID=sa;Password=123;TrustServerCertificate=True;"
    
    ci_bypass:
      file: ".github/workflows/ci.yml"
      issue: |
        $ignorePatterns = @("*.md", "*.txt", "*.yaml", "*.yml", "*.json")
        # ← *.json bị loại trừ → credentials trong appsettings.json KHÔNG bị detect

# ============================================================================
# GIẢI PHÁP
# ============================================================================
solution:
  approach: "XÓA credentials → Placeholder + Environment variable override"

  changes:

    # ----- CHANGE 1: appsettings.json → placeholder only -----
    - file: "src/TILSOFTAI.Api/appsettings.json"
      action: THAY THẾ ConnectionString
      description: "Xóa real credentials, thay bằng placeholder rõ ràng"

      before: |
        "Sql": {
          "ConnectionString": "Server=.;Database=TILSOFTAI;User ID=sa;Password=123;TrustServerCertificate=True;",

      after: |
        "Sql": {
          "ConnectionString": "__SQL_CONNECTION_STRING_FROM_ENV_OR_SECRET_STORE__",

      also_replace:
        - description: "Redis connection cũng cần placeholder"
          before: '"ConnectionString": "192.168.8.7:6379"'
          after: '"ConnectionString": "__REDIS_CONNECTION_STRING__"'

    # ----- CHANGE 2: appsettings.Development.json với local defaults -----
    - file: "src/TILSOFTAI.Api/appsettings.Development.json"
      action: THÊM comment hướng dẫn dùng User Secrets
      description: |
        Dev environment dùng dotnet user-secrets, KHÔNG hardcode trong file.
        appsettings.Development.json chỉ chứa non-sensitive overrides.

      content_guideline: |
        {
          // Connection strings: Dùng `dotnet user-secrets set "Sql:ConnectionString" "Server=..."`
          // KHÔNG đặt credentials ở đây
          "Logging": {
            "LogLevel": {
              "Default": "Debug",
              "Microsoft.AspNetCore": "Information"
            }
          },
          "Auth": {
            "AllowHeaderFallback": true
          }
        }

    # ----- CHANGE 3: appsettings.Sample.json cập nhật -----
    - file: "src/TILSOFTAI.Api/appsettings.Sample.json"
      action: CẬP NHẬT với hướng dẫn rõ ràng
      description: "Sample file chỉ chứa structure, không chứa real values"

      ensure_contains: |
        {
          "_README": "Copy this file to appsettings.Development.json. Set secrets via: dotnet user-secrets set 'Sql:ConnectionString' 'your-value'",
          "Sql": {
            "ConnectionString": "Server=YOUR_SERVER;Database=TILSOFTAI;User ID=YOUR_USER;Password=YOUR_PASSWORD;TrustServerCertificate=True;",
            "_note": "Use environment variables or dotnet user-secrets for actual values"
          }
        }

    # ----- CHANGE 4: Program.cs — Environment variable support -----
    - file: "src/TILSOFTAI.Api/Program.cs"
      action: THÊM environment variable override (nếu chưa có)
      description: |
        ASP.NET Core tự động đọc env vars với format Sql__ConnectionString.
        Đảm bảo AddEnvironmentVariables() được gọi.
        Thêm startup validation: nếu ConnectionString vẫn là placeholder → fail fast.

      add_after_builder_create: |
        // PATCH 31.02: Validate no placeholder secrets at startup
        var sqlConn = builder.Configuration["Sql:ConnectionString"];
        if (string.IsNullOrEmpty(sqlConn) || sqlConn.Contains("__") || sqlConn.Contains("YOUR_"))
        {
            if (!builder.Environment.IsDevelopment())
            {
                throw new InvalidOperationException(
                    "Sql:ConnectionString is not configured. " +
                    "Set via environment variable Sql__ConnectionString or secret store.");
            }
            else
            {
                // Dev mode: warn but don't crash (user secrets may load later)
                Console.WriteLine("WARNING: Sql:ConnectionString appears to be a placeholder. " +
                    "Use 'dotnet user-secrets set \"Sql:ConnectionString\" \"...\"' to configure.");
            }
        }

    # ----- CHANGE 5: .gitignore hardening -----
    - file: ".gitignore"
      action: KIỂM TRA và THÊM patterns
      description: "Đảm bảo bin/obj/publish outputs KHÔNG BAO GIỜ vào repo"

      ensure_patterns_exist:
        - "[Bb]in/"
        - "[Oo]bj/"
        - "[Pp]ublish/"
        - "*.user"
        - "appsettings.*.local.json"
        - "secrets.json"
        - ".env"
        - ".env.*"

    # ----- CHANGE 6: CI Secret Scanning — SỬA bug loại trừ *.json -----
    - file: ".github/workflows/ci.yml"
      action: THAY THẾ credential check step
      description: |
        Xóa bug loại trừ *.json khỏi scan.
        Thêm gitleaks-style check cover cả json, cs, config, ps1.

      replace_step_verify_no_hardcoded_credentials:
        before: |
          $ignorePatterns = @("*.md", "*.txt", "*.yaml", "*.yml", "*.json")
        
        after_full_step: |
          - name: Verify No Hardcoded Credentials
            shell: pwsh
            run: |
              Write-Host "Checking for hardcoded credentials..." -ForegroundColor Cyan
              $issues = @()
              
              # Scan ALL relevant files including JSON (the previous bug excluded *.json)
              $files = Get-ChildItem -Path ./src -Recurse -Include "*.cs", "*.json", "*.config", "*.ps1", "*.xml" |
                Where-Object { $_.FullName -notmatch '(\\|/)bin(\\|/)' -and $_.FullName -notmatch '(\\|/)obj(\\|/)' }
              
              foreach ($file in $files) {
                $content = Get-Content $file.FullName -Raw -ErrorAction SilentlyContinue
                if (-not $content) { continue }
                
                # Check for real credentials (not placeholders)
                if ($content -match '(?i)(Password|Pwd)\s*=\s*(?!(__|\$env:|YOUR_|%%))([^;\"]{3,})') {
                  # Exclude known safe patterns
                  if ($content -notmatch '__SQL_CONNECTION_STRING_FROM_ENV') {
                    $issues += "$($file.FullName): potential hardcoded credential"
                  }
                }
                
                # Check for API keys / tokens
                if ($content -match '(?i)(api[_-]?key|secret[_-]?key|access[_-]?token)\s*[:=]\s*[\"''][a-zA-Z0-9+/=]{16,}') {
                  $issues += "$($file.FullName): potential API key/token"
                }
              }
              
              if ($issues.Count -gt 0) {
                Write-Host ""
                Write-Host "ERROR: Hardcoded credentials detected!" -ForegroundColor Red
                foreach ($issue in $issues) {
                  Write-Host "  - $issue" -ForegroundColor Red
                }
                exit 1  # ← FAIL CI, không chỉ warning
              }
              
              Write-Host "No hardcoded credentials detected." -ForegroundColor Green

    # ----- CHANGE 7: Xóa bin artifacts nếu tồn tại -----
    - action: MANUAL
      description: |
        Nếu repo hiện tại có bin/Release outputs:
        1. git rm -r --cached src/TILSOFTAI.Api/bin/ 2>/dev/null
        2. git rm -r --cached src/TILSOFTAI.Api/obj/ 2>/dev/null
        3. git commit -m "chore: remove tracked bin/obj artifacts"
        4. Verify .gitignore covers [Bb]in/ and [Oo]bj/

# ============================================================================
# POST-DEPLOYMENT ACTIONS
# ============================================================================
post_deployment:
  - action: "Rotate exposed credentials"
    description: |
      SA password=123 đã bị expose. Sau khi deploy:
      1. Đổi password SA trên SQL Server
      2. Tạo service account riêng cho TILSOFTAI (không dùng SA)
      3. Cấu hình connection string mới qua environment variable

  - action: "Setup dotnet user-secrets cho dev team"
    commands: |
      cd src/TILSOFTAI.Api
      dotnet user-secrets init
      dotnet user-secrets set "Sql:ConnectionString" "Server=.;Database=TILSOFTAI;User ID=tilsoft_svc;Password=<new-strong-password>;TrustServerCertificate=True;"
      dotnet user-secrets set "Redis:ConnectionString" "localhost:6379"

# ============================================================================
# ACCEPTANCE CRITERIA
# ============================================================================
acceptance_criteria:
  - "appsettings.json KHÔNG chứa Password= với giá trị thực"
  - "appsettings.json chứa placeholder (__...__ hoặc YOUR_)"
  - "CI secret scan bao gồm *.json files"
  - "CI FAILS (exit 1) khi phát hiện credentials, không chỉ warning"
  - "Program.cs fail fast khi placeholder chưa được replace (production)"
  - ".gitignore bao gồm bin/, obj/, publish/"
  - "KHÔNG có bin/ hoặc obj/ tracked trong git"
