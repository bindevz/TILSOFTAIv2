# ============================================================================
# PATCH 31_05 — Channel-Based Safe Cache Write (thay Fire-and-Forget)
# ============================================================================
# Severity: P2
# Audit Finding: P2-OPS-01
# ============================================================================

patch: 31_05
title: "Channel-based background cache write với error logging"
severity: P2
status: pending

# ============================================================================
# VẤN ĐỀ HIỆN TẠI
# ============================================================================
problem:
  description: |
    AnalyticsOrchestrator ghi cache bằng fire-and-forget:
      _ = _cache.SetAsync(context.TenantId, userQuery, context.Roles, insight, ct);
    
    Hậu quả:
    - Exceptions bị nuốt (lost) hoàn toàn
    - Không có metrics cho cache write failures
    - Không thể diagnose cache reliability issues
    - Redis connection timeout có thể ảnh hưởng các request khác (known issue #2392)

  evidence:
    file: "src/TILSOFTAI.Orchestration/Analytics/AnalyticsOrchestrator.cs"
    line: 215
    code: '_ = _cache.SetAsync(context.TenantId, userQuery, context.Roles, insight, ct);'

# ============================================================================
# GIẢI PHÁP
# ============================================================================
solution:
  approach: |
    Dùng Channel<CacheWriteItem> bounded queue + BackgroundService consumer.
    - Producer (AnalyticsOrchestrator): TryWrite vào channel (non-blocking, O(1))
    - Consumer (BackgroundService): Dequeue + write cache + log errors + track metrics
    - Backpressure: BoundedChannel với DropOldest (stale cache data ít giá trị)

  changes:

    # ----- CHANGE 1: CacheWriteItem record -----
    - file: "src/TILSOFTAI.Orchestration/Analytics/AnalyticsCache.cs"
      action: THÊM record mới
      description: "Data object cho cache write queue"

      add_record: |
        /// <summary>
        /// PATCH 31.05: Item in the cache write background queue.
        /// </summary>
        public sealed record CacheWriteItem(
            string TenantId,
            string NormalizedQuery,
            IEnumerable<string>? Roles,
            InsightOutput Insight);

    # ----- CHANGE 2: ICacheWriteQueue interface -----
    - file: "src/TILSOFTAI.Orchestration/Analytics/AnalyticsCache.cs"
      action: THÊM interface
      description: "Abstraction cho cache write queue"

      add_interface: |
        /// <summary>
        /// PATCH 31.05: Queue for background cache writes.
        /// </summary>
        public interface ICacheWriteQueue
        {
            /// <summary>
            /// Enqueue a cache write. Non-blocking, returns false if queue is full.
            /// </summary>
            bool TryEnqueue(CacheWriteItem item);
        }

    # ----- CHANGE 3: Tạo CacheWriteBackgroundService -----
    - file: "src/TILSOFTAI.Infrastructure/Caching/CacheWriteBackgroundService.cs"
      action: TẠO MỚI
      description: |
        BackgroundService đọc từ Channel<CacheWriteItem> và ghi cache.
        Logs failures, tracks metrics.

      content: |
        using System.Threading.Channels;
        using Microsoft.Extensions.Hosting;
        using Microsoft.Extensions.Logging;
        using TILSOFTAI.Domain.Metrics;
        using TILSOFTAI.Orchestration.Analytics;

        namespace TILSOFTAI.Infrastructure.Caching;

        /// <summary>
        /// PATCH 31.05: Background service that processes cache write queue.
        /// Replaces fire-and-forget pattern with reliable background processing.
        /// </summary>
        public sealed class CacheWriteBackgroundService : BackgroundService, ICacheWriteQueue
        {
            private readonly Channel<CacheWriteItem> _channel;
            private readonly AnalyticsCache _cache;
            private readonly IMetricsService _metrics;
            private readonly ILogger<CacheWriteBackgroundService> _logger;

            public CacheWriteBackgroundService(
                AnalyticsCache cache,
                IMetricsService metrics,
                ILogger<CacheWriteBackgroundService> logger)
            {
                _cache = cache ?? throw new ArgumentNullException(nameof(cache));
                _metrics = metrics ?? throw new ArgumentNullException(nameof(metrics));
                _logger = logger ?? throw new ArgumentNullException(nameof(logger));

                // Bounded channel: nếu queue đầy, drop item cũ nhất (stale data)
                _channel = Channel.CreateBounded<CacheWriteItem>(
                    new BoundedChannelOptions(capacity: 256)
                    {
                        FullMode = BoundedChannelFullMode.DropOldest,
                        SingleReader = true,   // Chỉ 1 consumer
                        SingleWriter = false   // Nhiều producers (concurrent requests)
                    });
            }

            /// <summary>Non-blocking enqueue. Returns false if channel is completed.</summary>
            public bool TryEnqueue(CacheWriteItem item)
            {
                if (!_channel.Writer.TryWrite(item))
                {
                    _logger.LogWarning("CacheWriteQueue full, dropping oldest item");
                    _metrics.Increment("cache_write_dropped_total");
                    return false;
                }
                return true;
            }

            protected override async Task ExecuteAsync(CancellationToken stoppingToken)
            {
                _logger.LogInformation("CacheWriteBackgroundService started");

                await foreach (var item in _channel.Reader.ReadAllAsync(stoppingToken))
                {
                    try
                    {
                        await _cache.SetAsync(
                            item.TenantId, 
                            item.NormalizedQuery, 
                            item.Roles, 
                            item.Insight, 
                            stoppingToken);

                        _metrics.Increment("cache_write_success_total");
                    }
                    catch (Exception ex)
                    {
                        _logger.LogError(ex,
                            "CacheWriteFailed | Tenant: {TenantId} | Query: {Query} | Error: {Error}",
                            item.TenantId, 
                            item.NormalizedQuery?.Length > 50 
                                ? item.NormalizedQuery[..50] + "..." 
                                : item.NormalizedQuery,
                            ex.Message);

                        _metrics.Increment("cache_write_failures_total");
                        // Do NOT rethrow — continue processing next item
                    }
                }

                _logger.LogInformation("CacheWriteBackgroundService stopped");
            }

            public override async Task StopAsync(CancellationToken cancellationToken)
            {
                _channel.Writer.Complete();
                await base.StopAsync(cancellationToken);
            }
        }

    # ----- CHANGE 4: AnalyticsOrchestrator dùng queue thay fire-and-forget -----
    - file: "src/TILSOFTAI.Orchestration/Analytics/AnalyticsOrchestrator.cs"
      action: THAY THẾ fire-and-forget calls
      description: "Inject ICacheWriteQueue, gọi TryEnqueue thay _ = SetAsync"

      constructor_add: |
        private readonly ICacheWriteQueue _cacheWriteQueue;
        // Thêm vào constructor:
        // ICacheWriteQueue cacheWriteQueue

      replace_line_215:
        before: |
          // Cache async (fire-and-forget)
          // PATCH 30.03: Include roles for security-isolated cache
          _ = _cache.SetAsync(context.TenantId, userQuery, context.Roles, insight, ct);
        
        after: |
          // PATCH 31.05: Safe background cache write via Channel queue
          _cacheWriteQueue.TryEnqueue(new CacheWriteItem(
              context.TenantId, userQuery, context.Roles, insight));

    # ----- CHANGE 5: DI Registration -----
    - file: "src/TILSOFTAI.Api/Extensions/AddTilsoftAiExtensions.cs"
      action: THÊM registration
      description: "Register CacheWriteBackgroundService as both IHostedService and ICacheWriteQueue"

      add_registration: |
        // PATCH 31.05: Background cache write service
        services.AddSingleton<CacheWriteBackgroundService>();
        services.AddSingleton<ICacheWriteQueue>(sp => 
            sp.GetRequiredService<CacheWriteBackgroundService>());
        services.AddHostedService(sp => 
            sp.GetRequiredService<CacheWriteBackgroundService>());

    # ----- CHANGE 6: Metrics -----
    - file: "src/TILSOFTAI.Domain/Metrics/MetricNames.cs"
      action: THÊM metric names
      description: "Thêm cache write metrics"

      add_constants: |
        // PATCH 31.05: Cache write background queue metrics
        public const string CacheWriteSuccessTotal = "cache_write_success_total";
        public const string CacheWriteFailuresTotal = "cache_write_failures_total";
        public const string CacheWriteDroppedTotal = "cache_write_dropped_total";

# ============================================================================
# ACCEPTANCE CRITERIA
# ============================================================================
acceptance_criteria:
  - "Cache write failures được logged với tenant/query context"
  - "Cache write KHÔNG block request pipeline (non-blocking TryEnqueue)"
  - "Prometheus metrics: cache_write_success_total, cache_write_failures_total, cache_write_dropped_total"
  - "BackgroundService graceful shutdown: complete channel, drain remaining items"
  - "Queue overflow: DropOldest strategy (stale cache ít giá trị hơn fresh)"
  - "Không còn _ = _cache.SetAsync() fire-and-forget trong codebase"
