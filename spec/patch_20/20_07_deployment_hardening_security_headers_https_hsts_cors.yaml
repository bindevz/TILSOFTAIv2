schema_version: "1.0"
document: "PATCH 20.07 - Deployment Hardening (HTTPS/HSTS, Security Headers, CORS Policy)"
language: "en"

problem_statement:
  - "API lacks baseline deployment hardening: HSTS/HTTPS redirect/security headers/CORS policy."
  - "Enterprise requires explicit policies and safe defaults."

goals:
  - "Add HTTPS redirection + HSTS in non-development."
  - "Add baseline security headers middleware."
  - "Add explicit CORS policy (disabled by default; allowlist origins)."
  - "Ensure health endpoints are not blocked by CORS or auth."

hard_constraints:
  - "Do not break local development."
  - "CORS must be opt-in with allowlisted origins."
  - "Headers must not leak server details."

files_to_create_or_modify:
  create:
    - path: "src/TILSOFTAI.Api/Middlewares/SecurityHeadersMiddleware.cs"
      requirements:
        - "Set: X-Content-Type-Options=nosniff"
        - "Set: X-Frame-Options=DENY (or SAMEORIGIN if needed)"
        - "Set: Referrer-Policy=no-referrer"
        - "Set: Permissions-Policy=()"
        - "Set: Cache-Control=no-store for auth/token endpoints if any"
        - "Do NOT set CSP unless explicitly configured (to avoid breaking clients), but leave hook for future."
  modify:
    - path: "src/TILSOFTAI.Api/Program.cs"
      changes:
        - "In non-development: app.UseHsts(); app.UseHttpsRedirection();"
        - "Add app.UseMiddleware<SecurityHeadersMiddleware>();"
        - "Configure CORS: AddCors policy 'Default' with allowlisted origins from config; apply to controllers + hubs if enabled."
    - path: "src/TILSOFTAI.Domain/Configuration/CorsOptions.cs"
      create_or_modify:
        - "Enabled bool default false"
        - "AllowedOrigins string[] default []"
        - "AllowCredentials bool default true (if used with SignalR, ensure origins not wildcard)"
        - "AllowedHeaders/Methods default to minimal"
    - path: "src/TILSOFTAI.Api/Extensions/AddTilsoftAiExtensions.cs"
      changes:
        - "Bind CorsOptions and configure services.AddCors accordingly."
        - "Validate: if AllowCredentials=true then no wildcard origins."
  tests_optional:
    - "Contract test: security headers present on a typical response."

acceptance_criteria:
  - "In Production: HSTS and HTTPS redirection enabled."
  - "Security headers are present."
  - "CORS is disabled unless explicitly enabled and allowlisted."
