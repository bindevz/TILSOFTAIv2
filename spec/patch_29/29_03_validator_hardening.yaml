# File: PATCH_PACK_29/29_03_validator_hardening.yaml
patch_pack: 29
pack_id: "29_03"
title: "Validator Correctness + Contract Alignment (No substring allowlists)"
priority: "P0"
goal:
  - "Validator must be exact-match, emit correct error codes, and support repair loops reliably."

tasks:
  - id: "29_03_T01"
    summary: "Replace CHARINDEX allowlist checks with exact token matching"
    files:
      - path: "sql/02_modules/analytics/004_sps_ai_analytics.sql"
        diff_intent: >
          In dbo.ai_analytics_validate_plan:
          - replace CHARINDEX-based checks for ops/metric ops with exact match using STRING_SPLIT into table variables
          - normalize tokens to lower-case and trim
    acceptance_criteria:
      - "Invalid ops that are substrings of valid ops are rejected (e.g., 'in' doesn't match 'min')."
    checklist:
      - "[ ] Unit test query plans in smoke script."

  - id: "29_03_T02"
    summary: "Align error codes to PlanValidationErrorCodes (no INVALID_METRIC drift)"
    files:
      - path: "sql/02_modules/analytics/004_sps_ai_analytics.sql"
        diff_intent: "Emit INVALID_OP for unsupported metric op; emit UNKNOWN_FIELD for missing metric field."
      - path: "src/TILSOFTAI.Domain/Analytics/PlanValidationResult.cs"
        diff_intent: >
          If INVALID_METRIC exists, either remove it and use INVALID_OP, or add it consistently across domain + SQL.
          Prefer: standardize on INVALID_OP.
    acceptance_criteria:
      - "All validator error codes are defined in domain constants."
      - "LLM repair loop can map error -> suggestions reliably."
    checklist:
      - "[ ] Search entire repo for INVALID_METRIC usage; eliminate inconsistency."

  - id: "29_03_T03"
    summary: "Time-window validation tied to dataset.TimeColumn; support between/gte/lte correctly"
    files:
      - path: "sql/02_modules/analytics/004_sps_ai_analytics.sql"
        diff_intent: >
          Implement TIME_WINDOW_EXCEEDED only when filtering on dataset time column (from DatasetCatalog.TimeColumn or semanticType='date').
          Parse where entries for between/gte/lte; compute days difference; compare to MaxTimeWindowDays.
    acceptance_criteria:
      - "Time-window limit triggers only for proper date/time fields."
      - "False positives eliminated."
    checklist:
      - "[ ] Use TRY_CONVERT(datetime2, ...) and safe parsing."

  - id: "29_03_T04"
    summary: "Validate orderBy fields and metric aliases"
    files:
      - path: "sql/02_modules/analytics/004_sps_ai_analytics.sql"
        diff_intent: >
          Ensure orderBy.field references either a groupBy/select field or a metric alias.
          Reject unknown with UNKNOWN_FIELD + suggestions.
    acceptance_criteria:
      - "Plans ordering by unknown field are rejected deterministically."

exit_gate:
  - "Validator is exact-match and contract-aligned; repair loops become predictable."
