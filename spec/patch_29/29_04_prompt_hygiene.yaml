# File: PATCH_PACK_29/29_04_prompt_hygiene.yaml
patch_pack: 29
pack_id: "29_04"
title: "Prompt Hygiene: Remove Tool Instruction Duplication + Short System Prompt"
priority: "P0"
goal:
  - "Reduce token bloat and tool confusion (single source of tool instruction)."

tasks:
  - id: "29_04_T01"
    summary: "Add ToolCatalogContextPackOptions.Enabled and default to false"
    files:
      - path: "src/TILSOFTAI.Domain/Configuration/ToolCatalogContextPackOptions.cs"
        diff_intent: "Add Enabled bool default=false."
      - path: "src/TILSOFTAI.Infrastructure/Prompting/ToolCatalogContextPackProvider.cs"
        diff_intent: "Return empty packs when Enabled=false."
      - path: "src/TILSOFTAI.Api/appsettings.json"
        diff_intent: "Set ToolCatalogContextPack.Enabled=false by default."
    acceptance_criteria:
      - "System prompt no longer contains tool_catalog listing when disabled."
      - "Tool calling remains functional via tools payload."
    checklist:
      - "[ ] No other code assumes tool_catalog exists."

  - id: "29_04_T02"
    summary: "Shorten base system prompt: remove model-centric boilerplate; enforce 'no guessing' + 'user language'"
    files:
      - path: "src/TILSOFTAI.Orchestration/Prompting/PromptBuilder.cs"
        diff_intent: >
          Replace long system prompt with compact policy:
          - Use tools for facts; do not guess missing data
          - Reply in user's language unless asked otherwise
          - Follow tool outputs strictly
    acceptance_criteria:
      - "System prompt size reduced materially (manual spot check)."
      - "No 'Respond in language: en' pin unless user language is en."
    checklist:
      - "[ ] Keep prompt deterministic; no tool list duplication."

exit_gate:
  - "Token usage reduced; tool selection becomes more reliable."
