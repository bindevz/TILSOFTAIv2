# File: PATCH_PACK_29/29_09_tests_and_observability.yaml
patch_pack: 29
pack_id: "29_09"
title: "Tests + Observability for Analytics E2E"
priority: "P2"
goal:
  - "Prove deterministic analytics pipeline works and is diagnosable in production."

tasks:
  - id: "29_09_T01"
    summary: "Add unit tests for intent detector, canonicalizer, and renderer"
    files:
      - path: "tests/TILSOFTAI.Tests/Analytics/AnalyticsIntentDetectorTests.cs"
        diff_intent: "Test vi/en triggers and false-positive prevention."
      - path: "tests/TILSOFTAI.Tests/Normalization/PromptTextCanonicalizerTests.cs"
        diff_intent: "Test NBSP/tabs/multi-spaces/CRLF normalization."
      - path: "tests/TILSOFTAI.Tests/Analytics/InsightRendererTests.cs"
        diff_intent: "Assert headline single-line + notes include freshness/warnings."
    acceptance_criteria:
      - "Tests pass in CI and cover key deterministic behavior."

  - id: "29_09_T02"
    summary: "Add integration test for analytics query (catalog->plan->validate->execute->render)"
    files:
      - path: "tests/TILSOFTAI.IntegrationTests/Analytics/DeepAnalyticsE2ETests.cs"
        diff_intent: >
          Stand up test DB (local or container), seed minimal catalog + sample dataset,
          run query 'bao nhiêu model mùa 25/26' and assert:
          - headline exists
          - at least one breakdown table
          - notes include filter/limit/warnings/freshness
    acceptance_criteria:
      - "E2E test passes and prevents regressions."

  - id: "29_09_T03"
    summary: "Add structured logging for analytics (correlationId, planHash, toolCallCount, retryCount, cacheHit)"
    files:
      - path: "src/TILSOFTAI.Orchestration/Analytics/AnalyticsOrchestrator.cs"
        diff_intent: "Emit structured logs at each stage; include durations."
      - path: "src/TILSOFTAI.Infrastructure/Llm/OpenAiCompatibleLlmClient.cs"
        diff_intent: "Log token usage (if available) and tool call counts (no sensitive content)."
    acceptance_criteria:
      - "Logs allow tracing one analytics request end-to-end with correlationId."

exit_gate:
  - "Analytics pipeline is test-backed and operationally diagnosable."
