# File: PATCH_PACK_29/00_overview.yaml
patch_pack: 29
title: "PATCH 29 â€” Deep Analytics Enterprise E2E Hardening (No version bump, overwrite changes)"
mode:
  change_strategy: "overwrite_in_place"
  versioning: "DO_NOT_BUMP (no csproj/package/assembly version changes)"
  compatibility: "backwards-compatible preferred; breaking changes only if unavoidable and isolated to analytics flow"
scope:
  - "Make Deep Analytics truly executable end-to-end (schema RAG -> plan -> validate -> execute metrics -> insight -> render)."
  - "Eliminate prompt/tool duplication + language/whitespace instability."
  - "Enforce governance: RBAC + SecurityTag policy + limits."
  - "Operational readiness: persistence, cache, observability, tests, CI/deploy hygiene."

current_project_map:
  api:
    root: "src/TILSOFTAI.Api"
    entrypoints:
      - "Controllers/OpenAiChatCompletionsController.cs"
      - "Extensions/AddTilsoftAiExtensions.cs"
      - "appsettings.json"
  orchestration:
    root: "src/TILSOFTAI.Orchestration"
    key:
      - "ChatPipeline.cs"
      - "Normalization/*"
      - "Prompting/*"
      - "Analytics/* (exists but not enforced)"
  infrastructure:
    root: "src/TILSOFTAI.Infrastructure"
    key:
      - "Llm/OpenAiCompatibleLlmClient.cs"
      - "Prompting/ToolCatalogContextPackProvider.cs"
  modules:
    analytics:
      root: "src/TILSOFTAI.Modules.Analytics"
      expectation: "register tool handlers for analytics tools + new analytics_execute_plan"
  sql:
    root: "sql"
    atomic:
      - "02_atomic/* (catalog tables + ai_atomic_execute_plan)"
    analytics_module:
      - "02_modules/analytics/* (catalog views + ai_catalog_* + ai_analytics_validate_plan + app_analytics_*)"
    seed:
      - "99_seed/analytics/* (toolcatalog + translations + metadata dictionary)"
  migrations_tooling:
    expectation:
      - "tools/TILSOFTAI.Migrations (preferred over ad-hoc deploy-sql.ps1)"
      - "CI should validate migrations and required SQL assets exist"

enterprise_acceptance_bar:
  must_have:
    - "Analytics queries execute deterministically with bounded retries (no LLM free-form tool wandering)."
    - "Metrics (count/sum/avg/...) are executable securely (no fake validation)."
    - "Output contract ALWAYS: 1-line headline + breakdown table(s) + notes (filters/limit/warnings/freshness)."
    - "No tool instruction duplication in system prompt vs tools payload."
    - "Language negotiation: reply in user's language; Vietnamese supported."
    - "RBAC: analytics tools require roles; SecurityTag enforced with role-aware policy."
    - "Observability: correlationId, planHash, toolCallCount, retryCount, cacheHit logged."
    - "CI gates: validate required files + run tests + SQL compile smoke test."

global_constraints:
  - "Do not change product version numbers anywhere."
  - "Avoid introducing new external dependencies unless necessary (prefer built-in .NET / SQL)."
  - "All SQL scripts must be idempotent (CREATE OR ALTER / IF EXISTS guards)."
  - "All tool contracts must match implementation (no contract drift)."

deliverables:
  - "Multiple patch packs (29_01..29_09) each focused, executable, testable."
  - "Each pack contains: tasks with file paths, diff intent, acceptance criteria, checklist."
